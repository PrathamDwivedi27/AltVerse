<!DOCTYPE html>
<html>
<head>
    <title>Socket.IO Universe Test</title>
    <style>
        body { font-family: sans-serif; display: flex; gap: 20px; }
        .container { border: 1px solid #ccc; padding: 10px; border-radius: 8px; }
        #log, #onlineUsersList { list-style-type: none; padding: 0; height: 200px; overflow-y: scroll; border: 1px solid #eee; margin-top: 10px; }
        #log li, #onlineUsersList li { padding: 5px; border-bottom: 1px solid #f0f0f0; }
        #typingStatus { color: #888; font-style: italic; height: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Controls</h2>
        <div>
            <label>User ID:</label>
            <input id="userId" value="64f1234567890abc12345678" />
        </div>
        <div>
            <label>Username:</label>
            <input id="username" value="TestUser" />
        </div>
        <button onclick="authenticateUser()">Authenticate</button>
        <hr>
        <div>
            <label>Universe ID:</label>
            <input id="universeId" value="64f876543210abc987654321" />
        </div>
        <button onclick="joinRoom()">Join Room</button>
        <button onclick="leaveRoom()">Leave Room</button>
        <hr>
        <div>
            <!-- MODIFICATION: Use oninput for the typing logic -->
            <input id="messageInput" placeholder="Type a message" oninput="handleTyping()" />
            <button onclick="sendMessage()">Send Message</button>
        </div>
        <div id="typingStatus"></div>
    </div>

    <div class="container">
        <h2>Event Log</h2>
        <ul id="log"></ul>
    </div>

    <div class="container">
        <h2>Online Users</h2>
        <ul id="onlineUsersList"></ul>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io("http://localhost:4000"); // Replace with your PORT if different

        const logElement = document.getElementById("log");
        const onlineUsersList = document.getElementById("onlineUsersList");
        const typingStatus = document.getElementById("typingStatus");
        
        // --- NEW: Timer for typing logic ---
        let typingTimeout;
        let isTyping = false;

        function log(message) {
            const li = document.createElement("li");
            li.textContent = message;
            logElement.appendChild(li);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // --- CORE LISTENERS ---
        socket.on("connect", () => log(`Connected: ${socket.id}`));
        socket.on("disconnect", () => log(`Disconnected`));
        socket.on("user-joined", (msg) => log(`JOIN: ${msg}`));
        socket.on("user-left", (msg) => log(`LEAVE: ${msg}`));
        socket.on("new-message", (data) => {
            typingStatus.textContent = ''; // Clear typing status when a message arrives
            log(`MESSAGE: ${data.sender.username}: ${data.text}`)
        });

        // --- TYPING LISTENERS ---
        socket.on('user-is-typing', (data) => {
            typingStatus.textContent = `${data.username} is typing...`;
        });
        socket.on('user-stopped-typing', (data) => {
            // Only clear the status if it's the correct user
            if (typingStatus.textContent.includes(data.username)) {
                typingStatus.textContent = '';
            }
        });

        // --- ONLINE STATUS LISTENER ---
        socket.on('online-users-update', (users) => {
            onlineUsersList.innerHTML = ''; // Clear the list
            users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user.username;
                onlineUsersList.appendChild(li);
            });
        });

        // --- EMITTERS ---
        function getUserDetails() {
            return {
                _id: document.getElementById("userId").value,
                username: document.getElementById("username").value
            };
        }

        function authenticateUser() {
            socket.emit("authenticate", getUserDetails());
            log(`Authenticated as ${getUserDetails().username}`);
        }

        function joinRoom() {
            socket.emit("join-room", { 
                universeId: document.getElementById("universeId").value, 
                user: getUserDetails() 
            });
        }

        function leaveRoom() {
            socket.emit("leave-room", { 
                universeId: document.getElementById("universeId").value, 
                user: getUserDetails() 
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById("messageInput");
            if (messageInput.value.trim() === '') return; // Don't send empty messages

            const msg = {
                universeId: document.getElementById("universeId").value,
                senderId: document.getElementById("userId").value,
                type: "text",
                content: messageInput.value
            };
            socket.emit("send-message", msg);
            messageInput.value = '';
            stopTyping(); // Manually send stop-typing after sending a message
        }

        // --- NEW: Improved Typing Logic ---
        function handleTyping() {
            // If not already typing, send the start event
            if (!isTyping) {
                isTyping = true;
                socket.emit('start-typing', {
                    universeId: document.getElementById("universeId").value,
                    user: getUserDetails()
                });
            }
            
            // Clear the previous timeout
            clearTimeout(typingTimeout);

            // Set a new timeout. If it fires, it means the user has stopped typing.
            typingTimeout = setTimeout(() => {
                stopTyping();
            }, 1500); // 1.5 seconds
        }

        function stopTyping() {
            isTyping = false;
            clearTimeout(typingTimeout);
            socket.emit('stop-typing', {
                universeId: document.getElementById("universeId").value,
                user: getUserDetails()
            });
        }
    </script>
</body>
</html>
